---
import { siteConfig, navigationConfig } from '../config/index'
import SearchDrawer from './SearchDrawer.astro'
import ThemeToggle from './ThemeToggle.astro'

const { currentPage } = Astro.props
---

<header class="header">
  <nav class="nav">
    <div class="nav-container">
      <div class="nav-top">
        <a href="/" class="logo" aria-label="回到主页">
          <span class="logo-mark">
            {
              siteConfig.logoImage ? (
                <img src={siteConfig.logoImage} alt="Logo" class="logo-image" />
              ) : (
                siteConfig.logoMark
              )
            }
          </span>
          <span class="logo-copy">
            <span class="logo-name">{siteConfig.logoName}</span>
            <span class="logo-meta">{siteConfig.logoMeta}</span>
          </span>
        </a>
        <div class="nav-utilities">
          <button
            type="button"
            class="search-button"
            id="search-trigger"
            aria-label="Search"
            aria-controls="search-drawer"
            aria-expanded="false"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <span class="search-label">{siteConfig.searchLabel}</span>
            <kbd class="search-shortcut">/</kbd>
          </button>
          <ThemeToggle />
          <a
            href={siteConfig.chatBotUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="icon-button"
            aria-label="Chat Bot"
            title="Chat Bot"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 8V4H8"></path>
              <rect width="16" height="12" x="4" y="8" rx="2"></rect>
              <path d="M2 14h2"></path>
              <path d="M20 14h2"></path>
              <path d="M15 13v2"></path>
              <path d="M9 13v2"></path>
            </svg>
          </a>
          <button
            type="button"
            class="icon-button"
            aria-label="通知"
            aria-disabled="true"
            title="通知模块已停用，仅保留图标"
            disabled
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
          </button>
          <button
            type="button"
            class="icon-button"
            id="rss-button"
            aria-label="复制 RSS 订阅链接"
            title="复制 RSS 订阅链接"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M4 11a9 9 0 0 1 9 9"></path>
              <path d="M4 4a16 16 0 0 1 16 16"></path>
              <circle cx="5" cy="19" r="2"></circle>
            </svg>
          </button>
          <button
            type="button"
            class="icon-button"
            id="sitemap-button"
            aria-label="复制 Sitemap 链接"
            title="复制 Sitemap 链接"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <rect x="16" y="16" width="6" height="6" rx="1"></rect>
              <rect x="2" y="16" width="6" height="6" rx="1"></rect>
              <rect x="9" y="2" width="6" height="6" rx="1"></rect>
              <path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3"></path>
              <path d="M12 12V8"></path>
            </svg>
          </button>
          <a
            href={siteConfig.githubUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="icon-button"
            aria-label="GitHub Repository"
            title="GitHub Repository"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path
                d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"
              ></path>
              <path d="M9 18c-4.51 2-5-2-7-2"></path>
            </svg>
          </a>
          <a
            href={siteConfig.githubUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="avatar-button"
            aria-label="访问 GitHub 主页"
          >
            {
              siteConfig.avatarImage ? (
                <img
                  src={siteConfig.avatarImage}
                  alt="Avatar"
                  class="avatar-image"
                />
              ) : (
                <span class="avatar-initial">{siteConfig.logoMark}</span>
              )
            }
          </a>
        </div>
      </div>
      <div class="nav-bottom">
        <div class="nav-links">
          {
            navigationConfig.items.map((item) => (
              <a
                href={item.href}
                class={currentPage === item.key ? 'active' : ''}
              >
                <svg
                  class="nav-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d={item.icon} />
                </svg>
                <span>{item.label}</span>
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- Toast 提示容器 -->
<div id="toast-container" class="toast-container"></div>

<SearchDrawer />

<style>
  .header {
    position: static;
    background: var(--header-bg, transparent);
    border-bottom: 1px solid var(--header-divider);
  }
  .nav {
    width: 100%;
  }
  .nav-container {
    max-width: var(--layout-max-width);
    margin: 0 auto;
    padding: 0.75rem calc(var(--layout-gap) + 1rem) 1rem;
    padding-left: calc(var(--layout-gap) + 0.35rem);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .nav-top {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .nav-utilities {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    --nav-control-size: 34px;
  }
  .nav-bottom {
    display: flex;
    justify-content: flex-start;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    color: var(--header-text-strong);
  }
  .logo-mark {
    display: grid;
    place-items: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid var(--header-accent-border);
    background: var(--header-mark-bg);
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--header-accent);
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }
  /* Logo 图片：移除圆形边框约束，保持原始形状 */
  .logo-mark:has(.logo-image) {
    border: none;
    background: transparent;
    border-radius: 0;
  }
  .logo-copy {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    line-height: 1.1;
  }
  .logo-name {
    font-size: 0.95rem;
    font-weight: 600;
    letter-spacing: 0.02em;
  }
  .logo-meta {
    font-size: 0.75rem;
    color: var(--header-text-muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .nav-links {
    display: flex;
    gap: 1.25rem;
    align-items: center;
    justify-content: flex-start;
  }
  .search-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    color: var(--header-text);
    background: var(--header-search-bg);
    border: 1px solid var(--header-accent-border);
    border-radius: 6px;
    text-decoration: none;
    padding: 0 0.75rem;
    transition: all 0.2s ease;
    font-size: 0.85rem;
    height: var(--nav-control-size);
    min-height: var(--nav-control-size);
    box-sizing: border-box;
    cursor: pointer;
    appearance: none;
    font: inherit;
  }
  .search-button:hover {
    color: var(--header-text-strong);
    border-color: var(--header-accent-border-strong);
    background: var(--header-search-bg-hover);
  }
  .search-button svg {
    width: 18px;
    height: 18px;
  }
  .icon-button,
  .avatar-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 1px solid transparent; /* GitHub style: transparent border by default */
    background: transparent; /* GitHub style: transparent bg by default */
    color: var(--header-text);
    padding: 0;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .icon-button {
    width: var(--nav-control-size);
    height: var(--nav-control-size);
  }
  .icon-button[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .icon-button:hover {
    color: var(--header-text-strong);
    background: var(--header-icon-bg-hover); /* Usually a light gray */
  }
  .icon-button svg {
    width: 18px;
    height: 18px;
  }
  .avatar-button {
    width: 28px;
    height: 28px;
    font-size: 0.95rem;
    font-weight: 600;
    border: none;
    background: transparent;
  }
  .avatar-button:hover {
    opacity: 0.8;
  }
  .avatar-initial {
    letter-spacing: 0.04em;
  }
  .logo-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .avatar-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--border-radius-sm);
  }
  .search-label {
    display: none;
  }
  .search-shortcut {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.1rem 0.4rem;
    border-radius: 6px;
    border: 1px solid var(--header-shortcut-border);
    background: var(--header-shortcut-bg);
    color: var(--header-text-muted);
    font-family: var(--font-family-mono);
    font-size: 0.65rem;
    line-height: 1;
  }
  .nav-links a {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--header-text);
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    border: none;
    background: transparent;
    transition:
      color var(--motion-duration-sm) var(--motion-ease-standard),
      background-color var(--motion-duration-sm) var(--motion-ease-standard);
    letter-spacing: 0.01em;
  }
  .nav-links a:hover {
    color: var(--header-text-strong);
    background: var(--header-pill-hover);
  }
  .nav-links a.active {
    color: var(--header-text-strong);
    font-weight: 600;
    background: transparent;
  }
  .nav-icon {
    width: 16px;
    height: 16px;
    opacity: 0.7;
    transition: opacity var(--motion-duration-sm) var(--motion-ease-standard);
  }
  .nav-links a:hover .nav-icon,
  .nav-links a.active .nav-icon {
    opacity: 1;
  }
  @media (max-width: 1440px) {
    .nav-container {
      padding: 0.75rem calc(var(--layout-gap) * 0.85) 1rem;
      padding-left: calc(var(--layout-gap) * 0.6);
    }
  }
  @media (max-width: 1024px) {
    .nav-container {
      padding: 1rem 1.5rem;
      padding-left: 1.15rem;
      gap: 0.75rem;
    }
    .nav-top {
      flex-wrap: wrap;
      row-gap: 0.75rem;
    }
    .nav-utilities {
      width: 100%;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    .nav-bottom {
      width: 100%;
    }
  }
  @media (max-width: 1280px) {
    .nav-links {
      flex-wrap: wrap;
      row-gap: 0.35rem;
    }
  }
  @media (max-width: 768px) {
    .nav-container {
      padding: 0 1rem;
    }
    .logo-name {
      font-size: 0.9rem;
    }
    .logo-meta {
      font-size: 0.7rem;
    }
    .nav-links {
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .nav-links a {
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
    }
    .nav-utilities {
      gap: 0.45rem;
    }
    .search-button {
      gap: 0.5rem;
      padding: 0 0.7rem;
    }
  }

  /* Toast 提示样式 */
  .toast-container {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    pointer-events: none;
  }

  :global(.toast) {
    display: flex;
    align-items: center;
    gap: 0.65rem;
    padding: 0.6rem 0.9rem;
    background: var(--header-search-bg);
    border: 1px solid var(--header-accent-border);
    border-radius: var(--border-radius);
    color: var(--header-text-strong);
    font-size: 0.85rem;
    font-weight: 500;
    box-shadow: 0 8px 20px var(--shadow-color);
    pointer-events: auto;
    animation: toast-slide-in var(--motion-duration-md)
      var(--motion-ease-standard);
    min-width: 240px;
    max-width: 560px;
    backdrop-filter: blur(6px);
  }

  :global(.toast.toast-hide) {
    animation: toast-slide-out var(--motion-duration-md)
      var(--motion-ease-standard) forwards;
  }

  :global(.toast-icon) {
    flex-shrink: 0;
    width: 18px;
    height: 18px;
  }

  @keyframes toast-slide-in {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes toast-slide-out {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(8px);
    }
  }

  @media (max-width: 768px) {
    .toast-container {
      bottom: 16px;
      left: 50%;
      right: auto;
      transform: translateX(-50%);
      padding: 0 16px;
      width: 100%;
      max-width: 560px;
    }

    :global(.toast) {
      min-width: auto;
      max-width: none;
      width: calc(100% - 32px);
    }
  }
</style>

<script>
  const rssButton = document.getElementById('rss-button')
  const sitemapButton = document.getElementById('sitemap-button')
  const toastContainer = document.getElementById('toast-container')
  const searchTrigger = document.getElementById('search-trigger')

  function showToast(message: string) {
    if (!toastContainer) return

    const toast = document.createElement('div')
    toast.className = 'toast'
    toast.innerHTML = `
      <svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
      <span>${message}</span>
    `

    toastContainer.appendChild(toast)

    // 2 秒后开始淡出动画
    setTimeout(() => {
      toast.classList.add('toast-hide')
      // 动画结束后移除元素
      setTimeout(() => {
        toast.remove()
      }, 200) // 与动画时长一致
    }, 2000)
  }

  async function copyRssUrl() {
    const rssUrl = 'https://ai.011070.xyz/rss.xml'

    try {
      await navigator.clipboard.writeText(rssUrl)
      showToast('已复制 RSS 订阅地址，可导入阅读器')
    } catch (err) {
      console.error('复制失败:', err)
      showToast('复制失败，请重试')
    }
  }

  rssButton?.addEventListener('click', copyRssUrl)

  async function copySitemapUrl() {
    const sitemapUrl = 'https://ai.011070.xyz/sitemap-index.xml'

    try {
      await navigator.clipboard.writeText(sitemapUrl)
      showToast('已复制 Sitemap 至剪贴板，可导入知识库')
    } catch (err) {
      console.error('复制失败:', err)
      showToast('复制失败，请重试')
    }
  }

  sitemapButton?.addEventListener('click', copySitemapUrl)

  const dispatchDrawerEvent = (type: string) => {
    const eventName =
      type === 'open' ? 'open-search-drawer' : 'toggle-search-drawer'
    document.dispatchEvent(new CustomEvent(eventName))
  }

  const tryOpenDrawer = () => {
    const drawer = document.getElementById('search-drawer')
    if (!drawer) return false
    dispatchDrawerEvent('open')
    return true
  }

  searchTrigger?.addEventListener('click', () => dispatchDrawerEvent('toggle'))

  document.addEventListener('search-drawer:state', (event) => {
    const detail = (event as CustomEvent)?.detail || {}
    const isOpen = Boolean(detail.open)
    searchTrigger?.setAttribute('aria-expanded', isOpen ? 'true' : 'false')
  })

  // 搜索快捷键：按下 '/' 打开搜索抽屉并聚焦输入
  function focusSearchInput() {
    const drawerInput = document.querySelector('#search-drawer-input')
    if (drawerInput instanceof HTMLInputElement) {
      drawerInput.focus()
      drawerInput.select()
      return true
    }
    return false
  }

  window.addEventListener('keydown', (e) => {
    // 忽略组合键与已处理事件
    if (e.defaultPrevented || e.ctrlKey || e.metaKey || e.altKey) return

    // 仅当按下 '/' 且不在可编辑元素内时触发
    const key = e.key || ''
    if (key !== '/') return

    const target = e.target as HTMLElement | null
    const tagName = target?.tagName
    const isEditable =
      target instanceof HTMLElement &&
      (target.isContentEditable ||
        ['INPUT', 'TEXTAREA', 'SELECT'].includes(tagName || ''))

    if (isEditable) return

    // 阻止在页面上输入 '/'
    e.preventDefault()

    if (tryOpenDrawer()) {
      focusSearchInput()
    }
  })
</script>
