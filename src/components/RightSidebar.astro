---
import '../styles/right-sidebar.css'
import SidebarPanels from './SidebarPanels.astro'
import type { SidebarSection } from '../scripts/sidebars'

const {
  structure = [],
  currentPath = '/',
  contributors,
  manualToc = false,
  showTocPanel = true,
}: {
  structure?: SidebarSection
  currentPath?: string
  contributors?: string[] | null
  manualToc?: boolean
  showTocPanel?: boolean
} = Astro.props
---

<div class="right-sidebar">
  <div class="sidebar-scroll">
    <SidebarPanels
      structure={structure}
      currentPath={currentPath}
      contributors={contributors}
      tocNavClass="toc-nav"
      showTocPanel={showTocPanel}
    />
  </div>
</div>

<script is:inline define:vars={{ manualToc }}>
  // 内联 TOC 实现 - 不依赖外部模块，直接执行
  (function() {
    if (manualToc) {
      // 由外层布局手动控制 TOC
      return
    }

    var root = document.querySelector('.content-inner')
    var nav = document.querySelector('.toc-nav')
    if (!root || !nav) return

    var headings = root.querySelectorAll('h2')
    nav.innerHTML = ''

    var tocLinks = []
    var headingEls = []

    for (var i = 0; i < headings.length; i++) {
      var h2 = headings[i]
      var id = h2.id || (h2.textContent || '').trim().toLowerCase().replace(/\s+/g, '-') || 'section-' + i
      if (!h2.id) h2.id = id

      var link = document.createElement('a')
      link.href = '#' + encodeURIComponent(id)
      link.textContent = h2.textContent || id
      link.title = h2.textContent || id
      link.className = 'toc-link toc-2'
      link.setAttribute('data-id', id)
      ;(function(targetId) {
        link.addEventListener('click', function(e) {
          e.preventDefault()
          var target = document.getElementById(targetId)
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' })
            history.replaceState(null, '', '#' + encodeURIComponent(targetId))
            // 点击时立即激活
            setActive(targetId)
            clickLockUntil = Date.now() + 800
          }
        })
      })(id)
      nav.appendChild(link)
      tocLinks.push({ id: id, el: link })
      headingEls.push({ id: id, el: h2 })
    }

    // 滚动观察：追踪当前可见的标题并激活对应 TOC 链接
    var clickLockUntil = 0

    function setActive(activeId) {
      for (var j = 0; j < tocLinks.length; j++) {
        var item = tocLinks[j]
        if (item.id === activeId) {
          item.el.classList.add('active')
        } else {
          item.el.classList.remove('active')
        }
      }
    }

    if (headingEls.length > 0 && typeof IntersectionObserver !== 'undefined') {
      var observer = new IntersectionObserver(function(entries) {
        if (Date.now() < clickLockUntil) return
        var best = null
        for (var k = 0; k < entries.length; k++) {
          var en = entries[k]
          if (!best || en.intersectionRatio > best.intersectionRatio) {
            best = en
          }
        }
        if (best && best.target && best.target.id) {
          setActive(best.target.id)
        }
      }, {
        rootMargin: '-40% 0px -55% 0px',
        threshold: [0, 0.25, 0.5, 0.75, 1]
      })

      for (var m = 0; m < headingEls.length; m++) {
        observer.observe(headingEls[m].el)
      }
    }

    // 初始 hash 高亮
    if (location.hash) {
      var hashId = decodeURIComponent(location.hash.slice(1))
      setActive(hashId)
    }

    // 检查 TOC 是否为空，如果为空则隐藏整个 toc-panel
    requestAnimationFrame(function() {
      var tocNav = document.querySelector('.toc-nav')
      var tocPanel = document.querySelector('.toc-panel')
      if (tocNav && tocPanel && tocNav.children.length === 0) {
        tocPanel.style.display = 'none'
      }
    })
  })()
</script>
