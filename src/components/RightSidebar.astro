---
import '../styles/right-sidebar.css'
import SidebarPanels from './SidebarPanels.astro'
import type { SidebarSection } from '../scripts/sidebars'

const {
  structure = [],
  currentPath = '/',
  contributors,
  manualToc = false,
}: {
  structure?: SidebarSection
  currentPath?: string
  contributors?: string[] | null
  manualToc?: boolean
} = Astro.props
---

<div class="right-sidebar">
  <div class="sidebar-scroll">
    <SidebarPanels
      structure={structure}
      currentPath={currentPath}
      contributors={contributors}
      tocNavClass="toc-nav"
    />
  </div>
</div>

<script is:inline type="module" define:vars={{ manualToc }}>
  import { setupRightSidebar } from '/scripts/toc.js'
  if (manualToc) {
    // 由外层布局手动控制 TOC
    return
  }

  const stop = setupRightSidebar('.content-inner', '.toc-nav')

  // 检查 TOC 是否为空，如果为空则隐藏整个 toc-panel
  requestAnimationFrame(() => {
    const tocNav = document.querySelector('.toc-nav')
    const tocPanel = document.querySelector('.toc-panel')
    if (tocNav && tocPanel && tocNav.children.length === 0) {
      tocPanel.style.display = 'none'
    }
  })

  if (import.meta?.hot) {
    import.meta.hot.on('vite:beforeUpdate', () => stop && stop())
  }
</script>
