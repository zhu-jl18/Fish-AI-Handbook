---
/**
 * 更新日志组件
 * 在构建时从 Git 获取最近提交并使用 LLM 生成摘要
 */
import { getChangelog, type CommitInfo } from '../../utils/changelog'

let commits: CommitInfo[] = []

try {
  commits = await getChangelog()
} catch (error) {
  console.error('Failed to load changelog:', error)
}

// 只显示最近 5 条
const display = Array.isArray(commits) ? commits.slice(0, 5) : []
---

<section class="changelog">
  <header class="changelog-header">
    <h2 class="changelog-title">Latest from our changelog</h2>
  </header>

  <div class="changelog-content">
    {
      display.length === 0 ? (
        <p class="changelog-empty">暂无更新记录</p>
      ) : (
        <ul class="changelog-list">
          {display.map((commit) => (
            <li class="changelog-item">
              <span class="changelog-dot" />
              <div class="changelog-detail">
                <span class="changelog-date">{commit.date}</span>
                <span class="changelog-summary">
                  {commit.summary || commit.message}
                </span>
              </div>
            </li>
          ))}
        </ul>
      )
    }
  </div>

  <footer class="changelog-footer">
    <a href="#" class="changelog-link">View changelog →</a>
  </footer>
</section>

<style>
  .changelog {
    /* 右侧去掉外边框，只保留时间线条和行间分隔线 */
    background: transparent;
    border: none;
    border-radius: 0;
    overflow: visible;
  }

  .changelog-header {
    padding: 0 0 0.4rem;
    border-bottom: none;
    background: transparent;
  }

  .changelog-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text-white);
    margin: 0;
  }

  .changelog-content {
    padding: 0.1rem 0;
  }

  .changelog-empty {
    color: var(--color-text-secondary);
    font-size: 0.8rem;
    margin: 0;
    padding: 0.5rem 0;
  }

  .changelog-list {
    list-style: none;
    margin: 0;
    padding: 0;
    position: relative;
  }

  .changelog-list::before {
    content: '';
    position: absolute;
    left: 3px;
    top: 0.5rem;
    bottom: 0.5rem;
    width: 1px;
    background: rgba(255, 255, 255, 0.06);
  }

  .changelog-item {
    display: flex;
    align-items: flex-start;
    gap: 0.625rem;
    padding: 0.55rem 0;
  }

  .changelog-dot {
    flex-shrink: 0;
    width: 8px;
    height: 8px;
    margin-top: 5px;
    border-radius: 50%;
    background: var(--color-text-secondary);
  }

  .changelog-detail {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .changelog-date {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .changelog-summary {
    font-size: 0.8rem;
    color: var(--link-color);
    line-height: 1.4;
  }

  .changelog-footer {
    padding: 0.6rem 0 0 1.2rem; /* 与 changelog item 文本左侧对齐（略右于竖线） */
    border-top: none; /* 去掉标题与底部链接之间的横向分割线 */
    background: transparent;
  }

  .changelog-link {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .changelog-link:hover {
    color: var(--link-color);
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .changelog-item {
      gap: 0.5rem;
    }
  }
</style>
