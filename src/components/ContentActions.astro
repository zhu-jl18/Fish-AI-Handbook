---
/**
 * ContentActions - 文档操作按钮组
 * 放置在文档内容顶部，提供复制源码、提交改进等功能
 */
const { entryId } = Astro.props as { entryId?: string }

// GitHub 仓库基础 URL
const GITHUB_REPO_BASE = 'https://github.com/zhu-jl18/Fish-AI-Handbook'

// 规范化 entryId，并根据实际存在的文件形态（叶子.md 或 目录/index.md）生成正确的 GitHub 编辑链接
let githubEditUrl = '#'
if (entryId) {
  const normalize = (raw: string) => {
    let s = String(raw || '').trim()
    s = s.replace(/\.(md|mdx)$/i, '') // 去扩展名
    s = s.replace(/\/index$/i, '') // 去尾部 index
    s = s.replace(/^\/+/, '') // 去前导斜杠
    return s
  }
  const id = normalize(entryId)

  // 利用 Vite 的 glob 仅判断路径是否存在（无需读取内容）
  const modules = import.meta.glob('/src/content/docs/**/*.md')
  const candidates = [
    `/src/content/docs/${id}.md`,
    `/src/content/docs/${id}/index.md`,
  ]
  const chosen = candidates.find((p) => p in modules) ?? candidates[0]
  githubEditUrl = `${GITHUB_REPO_BASE}/edit/main${chosen}`
}
---

<div class="content-actions">
  <!-- 按钮1: 复制Markdown源码 -->
  <button
    type="button"
    class="action-btn"
    id="copy-markdown-btn"
    aria-label="复制Markdown源码"
    title="复制Markdown源码"
    data-entry-id={entryId}
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>
  </button>

  <!-- 按钮2: 在GitHub上编辑 -->
  <a
    href={githubEditUrl}
    target="_blank"
    rel="noopener noreferrer"
    class="action-btn"
    aria-label="在GitHub上提交改进建议"
    title="在GitHub上提交改进建议"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M12 20h8"></path>
      <path
        d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"
      ></path>
    </svg>
  </a>

  <!-- 按钮3: 分享 -->
  <button
    type="button"
    class="action-btn"
    id="share-link-btn"
    aria-label="分享当前页面"
    title="分享当前页面"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <circle cx="18" cy="5" r="3"></circle>
      <circle cx="6" cy="12" r="3"></circle>
      <circle cx="18" cy="19" r="3"></circle>
      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
    </svg>
  </button>

  <!-- 按钮4: 评论（禁用） -->
  <button
    type="button"
    class="action-btn"
    disabled
    aria-label="评论（即将推出）"
    title="评论（即将推出）"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
      ></path>
    </svg>
  </button>

  <!-- 按钮5: 代码块（禁用） -->
  <button
    type="button"
    class="action-btn"
    disabled
    aria-label="代码块（即将推出）"
    title="代码块（即将推出）"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polyline points="16 18 22 12 16 6"></polyline>
      <polyline points="8 6 2 12 8 18"></polyline>
    </svg>
  </button>
</div>

<style>
  .content-actions {
    /* 本组件仅用于正文顶部的操作栏：
       通过负外边距把工具栏整体上提，以缩小"导航条下缘 → 工具栏"间距；
       右侧栏位于独立列，不受此局部上提影响。 */
    --actions-offset-top: clamp(20px, 6vw, 42px);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: calc(-1 * var(--actions-offset-top));
    margin-bottom: 1rem;
    background: transparent;
    border: none;
    position: relative;
    z-index: 0;
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border-radius: 12px;
    background: transparent;
    border: 1px solid transparent;
    color: var(--header-text);
    padding: 0;
    cursor: pointer;
    text-decoration: none;
    transition:
      color var(--motion-duration-sm) var(--motion-ease-standard),
      border-color var(--motion-duration-sm) var(--motion-ease-standard),
      background-color var(--motion-duration-sm) var(--motion-ease-standard),
      border-radius var(--motion-duration-sm) var(--motion-ease-standard),
      box-shadow var(--motion-duration-sm) var(--motion-ease-standard);
  }

  .action-btn:not(:disabled):hover {
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.07);
    border-color: rgba(255, 255, 255, 0.12);
    color: var(--header-text-strong);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.22);
  }

  .action-btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
    pointer-events: none;
  }

  .action-btn svg {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }

  /* 移动端保持相同尺寸 */
  @media (max-width: 768px) {
    .content-actions {
      /* 移动端头部更紧凑：减少上提量，避免与导航重叠 */
      --actions-offset-top: clamp(12px, 4vw, 28px);
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
  }
</style>

<script>
  /**
   * Toast 提示辅助函数
   * 复用 Header.astro 中已有的 toast-container
   */
  function showToast(message: string, type: 'success' | 'error' = 'success') {
    const container = document.getElementById('toast-container')
    if (!container) {
      alert(message)
      return
    }

    const toast = document.createElement('div')
    toast.className = 'toast'
    toast.innerHTML = `
      <svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        ${
          type === 'success'
            ? '<polyline points="20 6 9 17 4 12"></polyline>'
            : '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>'
        }
      </svg>
      <span>${message}</span>
    `

    container.appendChild(toast)

    // 2秒后开始淡出
    setTimeout(() => {
      toast.classList.add('toast-hide')
      setTimeout(() => {
        toast.remove()
      }, 200)
    }, 2000)
  }

  const SHARE_BASES = ['https://ai.011070.xyz', 'https://ai.functorfish.me']

  async function copyMarkdownSource(entryId: string | null | undefined) {
    if (!entryId) {
      showToast('未找到文档标识', 'error')
      return
    }

    try {
      // 规范化 entryId，消除 .md/.mdx 扩展与尾部 /index
      const normalize = (raw: string) => {
        let s = String(raw || '').trim()
        // 去扩展名（.md / .mdx）
        s = s.replace(/\.(md|mdx)$/i, '')
        // 去掉尾部的 /index
        s = s.replace(/\/index$/i, '')
        // 去掉开头的斜杠
        s = s.replace(/^\/+/, '')
        return s
      }
      const cleanId = normalize(entryId)

      // 使用 Vite 的 import.meta.glob 预加载所有 Markdown 文件为原始文本
      const modules = import.meta.glob('/src/content/docs/**/*.md', {
        query: '?raw',
        import: 'default',
      })

      // 支持两种物理结构：
      // 1) 目录 + index.md       -> /src/content/docs/${cleanId}/index.md
      // 2) 叶子单页（三级）      -> /src/content/docs/${cleanId}.md
      const candidates = [
        `/src/content/docs/${cleanId}.md`,
        `/src/content/docs/${cleanId}/index.md`,
      ]

      let loaded = false
      for (const p of candidates) {
        if (modules[p]) {
          const content = (await modules[p]()) as string
          await navigator.clipboard.writeText(content)
          showToast('已复制Markdown源码')
          loaded = true
          break
        }
      }

      if (!loaded) {
        // Fallback（开发模式）依次尝试两种路径
        let ok = false
        for (const p of candidates) {
          try {
            const response = await fetch(p)
            if (response.ok) {
              const content = await response.text()
              await navigator.clipboard.writeText(content)
              showToast('已复制Markdown源码')
              ok = true
              break
            }
          } catch {}
        }
        if (!ok) throw new Error('文件不存在或无法访问')
      }
    } catch (error) {
      console.error('复制失败:', error)
      showToast('复制失败或源文件不存在', 'error')
    }
  }

  function resolveShareOrigin() {
    const currentOrigin = window.location.origin
    const currentHost = window.location.host
    const matchesKnownHost = SHARE_BASES.some((base) => {
      try {
        return new URL(base).host === currentHost
      } catch {
        return false
      }
    })
    if (matchesKnownHost) return currentOrigin
    return SHARE_BASES[0]
  }

  function buildShareUrl() {
    const origin = resolveShareOrigin().replace(/\/$/, '')
    const path = `${window.location.pathname}${window.location.search}${window.location.hash}`
    return `${origin}${path}`
  }

  async function copyShareLink(link: string) {
    if (navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(link)
      return true
    }
    window.prompt('请复制以下分享链接', link)
    return false
  }

  async function shareCurrentPage() {
    const shareUrl = buildShareUrl()
    try {
      const copied = await copyShareLink(shareUrl)
      showToast(copied ? '分享链接已复制' : '请手动复制分享链接')
    } catch (error) {
      console.error('分享失败:', error)
      showToast('无法复制分享链接', 'error')
    }
  }

  /**
   * 绑定复制按钮点击事件
   */
  const copyBtn = document.getElementById('copy-markdown-btn')
  if (copyBtn) {
    copyBtn.addEventListener('click', () => {
      const entryId = copyBtn.getAttribute('data-entry-id')
      copyMarkdownSource(entryId)
    })
  }

  const shareBtn = document.getElementById('share-link-btn')
  if (shareBtn) {
    shareBtn.addEventListener('click', () => {
      shareCurrentPage()
    })
  }
</script>
