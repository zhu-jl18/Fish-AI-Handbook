---
import '../styles/right-sidebar.css'
import SidebarPanels from './SidebarPanels.astro'
import type { SidebarSection } from '../scripts/sidebars'

const {
  structure = [],
  currentPath = '/',
  contributors,
  showTocPanel = true,
}: {
  structure?: SidebarSection
  currentPath?: string
  contributors?: string[] | null
  showTocPanel?: boolean
} = Astro.props
---

<div id="mobile-menu-overlay" class="mobile-menu-overlay" aria-hidden="true">
  <div class="mobile-menu-drawer">
    <div class="mobile-menu-header">
      <span class="mobile-menu-title">On this page</span>
      <button
        id="close-mobile-menu"
        class="close-button"
        aria-label="Close menu"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="mobile-menu-content sidebar-scroll">
      <SidebarPanels
        structure={structure}
        currentPath={currentPath}
        contributors={contributors}
        tocNavClass="mobile-toc-nav toc-nav"
        showTocPanel={showTocPanel}
      />
    </div>
  </div>
</div>

<style>
  .mobile-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 200;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    display: none; /* Hidden by default */
  }

  .mobile-menu-overlay.open {
    opacity: 1;
    pointer-events: auto;
    display: block;
  }

  .mobile-menu-drawer {
    position: absolute;
    top: 0;
    right: 0;
    width: 280px;
    height: 100%;
    background: var(--bg-color);
    border-left: 1px solid var(--border-color);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
    box-shadow: -4px 0 16px rgba(0, 0, 0, 0.3);
  }

  .mobile-menu-overlay.open .mobile-menu-drawer {
    transform: translateX(0);
  }

  .mobile-menu-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
  }

  .mobile-menu-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-color);
  }

  .close-button {
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-button:hover {
    background: var(--bg-hover);
    color: var(--text-color);
  }

  .mobile-menu-content {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem;
    /* Reuse right-sidebar styles */
  }

  /* Ensure panels take full width in drawer */
  :global(.mobile-menu-content .panel) {
    width: 100%;
    box-sizing: border-box;
  }

  @media (min-width: 1025px) {
    .mobile-menu-overlay {
      display: none !important;
    }
  }
</style>

<script is:inline>
  // Mobile menu + TOC - 不依赖外部模块
  ;(function () {
    var overlay = document.getElementById('mobile-menu-overlay')
    var closeBtn = document.getElementById('close-mobile-menu')
    var drawer = overlay ? overlay.querySelector('.mobile-menu-drawer') : null
    var trigger = document.querySelector('.mobile-menu-trigger')

    function syncTrigger(open) {
      if (trigger)
        trigger.setAttribute('aria-expanded', open ? 'true' : 'false')
    }

    function closeMenu() {
      if (overlay) {
        overlay.classList.remove('open')
        overlay.setAttribute('aria-hidden', 'true')
      }
      document.body.style.overflow = ''
      syncTrigger(false)
      document.dispatchEvent(new CustomEvent('close-mobile-menu'))
    }

    function openMenu() {
      if (overlay) {
        overlay.classList.add('open')
        overlay.setAttribute('aria-hidden', 'false')
      }
      document.body.style.overflow = 'hidden'
      syncTrigger(true)
    }

    if (closeBtn) closeBtn.addEventListener('click', closeMenu)
    if (overlay) {
      overlay.addEventListener('click', function (e) {
        if (e.target === overlay) closeMenu()
      })
    }
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeMenu()
    })

    document.addEventListener('open-mobile-menu', openMenu)

    // Build mobile TOC (skip if TabContentLayout handles it)
    var hasTabContent = document.querySelector('.content-tab-panel') !== null
    if (!hasTabContent) {
      var root = document.querySelector('.content-inner')
      var nav = document.querySelector('.mobile-toc-nav')
      if (root && nav) {
        var headings = root.querySelectorAll('h2')
        nav.innerHTML = ''
        for (var i = 0; i < headings.length; i++) {
          var h2 = headings[i]
          var id =
            h2.id ||
            (h2.textContent || '').trim().toLowerCase().replace(/\s+/g, '-') ||
            'section-' + i
          if (!h2.id) h2.id = id
          var link = document.createElement('a')
          link.href = '#' + encodeURIComponent(id)
          link.textContent = h2.textContent || id
          link.title = h2.textContent || id
          link.className = 'toc-link toc-2'
          link.setAttribute('data-id', id)
          ;(function (targetId) {
            link.addEventListener('click', function (e) {
              e.preventDefault()
              var target = document.getElementById(targetId)
              if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' })
                history.replaceState(
                  null,
                  '',
                  '#' + encodeURIComponent(targetId),
                )
              }
            })
          })(id)
          nav.appendChild(link)
        }
      }
    }

    // Close menu on link click
    if (drawer) {
      var links = drawer.querySelectorAll('a')
      for (var j = 0; j < links.length; j++) {
        links[j].addEventListener('click', function () {
          setTimeout(closeMenu, 120)
        })
      }
    }
  })()
</script>
