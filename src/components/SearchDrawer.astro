---
import { siteConfig } from '../config/index'

const base = import.meta.env.BASE_URL ?? '/'
const pagefindBundle =
  (base.endsWith('/') ? base : `${base}/`) + 'pagefind/'
---

<div
  id="search-drawer"
  class="search-drawer"
  aria-hidden="true"
  data-bundle-path={pagefindBundle}
  data-base-path={base}
>
  <div class="search-backdrop" data-close></div>
  <div
    class="search-panel"
    role="dialog"
    aria-modal="true"
    aria-label="站内搜索"
  >
    <div class="search-panel-header">
      <div class="search-input-wrap">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input
          id="search-drawer-input"
          type="search"
          name="search"
          placeholder={`${siteConfig.searchLabel}…`}
          autocomplete="off"
          enterkeyhint="search"
          aria-label="搜索站内内容"
          aria-controls="search-results"
        />
      </div>
      <button
        type="button"
        class="panel-close"
        data-close
        aria-label="关闭搜索抽屉"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="search-body">
      <div class="search-meta">
        <div class="meta-title">实时搜索</div>
        <div class="meta-hint">打开后自动加载索引</div>
      </div>
      <div
        class="search-results"
        id="search-results"
        role="listbox"
        aria-label="搜索结果"
        data-state="idle"
      >
        <div class="results-loading" data-view="loading" aria-live="polite">
          <span class="loader" aria-hidden="true"></span>
          <span class="loading-copy" data-loading-text>正在加载搜索索引…</span>
        </div>
        <div class="placeholder-list" data-view="placeholder">
          <span class="placeholder-bar w-80"></span>
          <span class="placeholder-bar w-65"></span>
          <span class="placeholder-bar w-90"></span>
          <span class="placeholder-bar w-70"></span>
          <span class="placeholder-bar w-60"></span>
        </div>
        <div class="results-empty" data-view="empty" aria-live="polite">
          <span class="empty-title">等待输入</span>
          <span class="empty-hint">输入后自动搜索</span>
        </div>
        <div class="results-error" data-view="error" aria-live="assertive">
          <div class="error-title">搜索不可用</div>
          <div class="error-desc">本地未找到索引，请运行 npm run preview:search</div>
        </div>
        <div
          class="results-list"
          data-view="results"
          role="presentation"
        ></div>
      </div>
    </div>
  </div>
</div>

<style>
  .search-drawer {
    position: fixed;
    inset: 0;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding: 10vh 16px 4vh;
    z-index: 320;
    box-sizing: border-box;
    overflow-y: auto;
  }

  .search-drawer.open {
    display: flex;
  }

  .search-backdrop {
    position: absolute;
    inset: 0;
    background: var(--color-bg-overlay-dark);
    backdrop-filter: blur(6px);
    opacity: 0;
    transition: opacity var(--motion-duration-md) var(--motion-ease-standard);
  }

  .search-drawer.open .search-backdrop {
    opacity: 1;
  }

  .search-panel {
    position: relative;
    width: min(860px, 100%);
    max-height: min(760px, calc(100vh - 16vh));
    display: flex;
    flex-direction: column;
    background: var(--bg-elevated);
    border: 1px solid var(--header-accent-border);
    border-radius: 12px;
    box-shadow: 0 22px 72px var(--shadow-color);
    padding: 1rem 1rem 1.1rem;
    opacity: 0;
    transform: translateY(-8px) scale(0.99);
    transition:
      opacity var(--motion-duration-md) var(--motion-ease-standard),
      transform var(--motion-duration-md) var(--motion-ease-standard);
    overflow: hidden;
  }

  .search-drawer.open .search-panel {
    opacity: 1;
    transform: translateY(0) scale(1);
  }

  .search-panel-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .search-input-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 0.65rem;
    background: var(--header-search-bg);
    border: 1px solid var(--header-accent-border);
    border-radius: 10px;
    padding: 0.65rem 0.85rem;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
  }

  .search-input-wrap svg {
    color: var(--header-text-muted);
  }

  .search-input-wrap input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--header-text-strong);
    font-size: 0.95rem;
    outline: none;
    caret-color: var(--caret-color);
  }

  .search-input-wrap input::placeholder {
    color: var(--header-text-muted);
  }

  .panel-close {
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid var(--header-accent-border);
    background: var(--header-icon-bg);
    color: var(--header-text);
    cursor: pointer;
    transition: all var(--motion-duration-sm) var(--motion-ease-standard);
  }

  .panel-close:hover {
    background: var(--header-icon-bg-hover);
    color: var(--header-text-strong);
    border-color: var(--header-accent-border-strong);
  }

  .search-body {
    margin-top: 0.85rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    flex: 1;
    min-height: 0;
  }

  .search-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    color: var(--header-text-muted);
    font-size: 0.85rem;
  }

  .meta-title {
    color: var(--header-text-strong);
    font-weight: 600;
    letter-spacing: 0.01em;
  }

  .search-results {
    border: 1px dashed var(--header-accent-border);
    border-radius: 10px;
    background: var(--header-search-bg);
    padding: 1rem;
    min-height: 240px;
    display: flex;
    align-items: stretch;
    justify-content: flex-start;
    flex: 1;
    min-height: 0;
  }

  .search-results [data-view] {
    display: none;
    width: 100%;
  }

  .search-results[data-state='idle'] [data-view='placeholder'] {
    display: grid;
  }

  .search-results[data-state='engine-loading'] [data-view='loading'],
  .search-results[data-state='searching'] [data-view='loading'],
  .search-results[data-state='empty'] [data-view='empty'],
  .search-results[data-state='error'] [data-view='error'] {
    display: flex;
  }

  .search-results[data-state='results'] [data-view='results'] {
    display: grid;
  }

  .results-loading {
    align-items: center;
    justify-content: center;
    gap: 0.65rem;
    color: var(--header-text-muted);
    font-size: 0.9rem;
  }

  .loader {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid var(--header-accent-border);
    border-top-color: var(--header-text-strong);
    animation: spin 0.9s linear infinite;
  }

  .placeholder-list {
    width: 100%;
    display: grid;
    gap: 0.55rem;
  }

  .placeholder-bar {
    display: block;
    height: 12px;
    border-radius: 999px;
    background: var(--surface-tint-06);
    position: relative;
    overflow: hidden;
  }

  .placeholder-bar::after {
    content: '';
    position: absolute;
    inset: 0;
    transform: translateX(-100%);
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.12),
      transparent
    );
    animation: shimmer 1.4s infinite;
  }

  .placeholder-bar.w-90 {
    width: 90%;
  }

  .placeholder-bar.w-80 {
    width: 80%;
  }

  .placeholder-bar.w-70 {
    width: 70%;
  }

  .placeholder-bar.w-65 {
    width: 65%;
  }

  .placeholder-bar.w-60 {
    width: 60%;
  }

  .results-empty,
  .results-error {
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.35rem;
    color: var(--header-text-muted);
    text-align: center;
  }

  .error-title {
    color: var(--header-text-strong);
    font-weight: 600;
  }

  .results-list {
    display: grid;
    gap: 0.75rem;
    width: 100%;
    max-height: none;
    overflow: auto;
    flex: 1;
    min-height: 0;
    padding-right: 0.25rem;
  }

  .result-item {
    display: block;
    padding: 0.65rem 0.75rem;
    border-radius: 8px;
    border: 1px solid transparent;
    background: rgba(255, 255, 255, 0.02);
    text-decoration: none;
    color: var(--header-text);
    transition: all var(--motion-duration-sm) var(--motion-ease-standard);
  }

  .result-item:hover {
    border-color: var(--header-accent-border);
    background: var(--header-search-bg-hover);
    color: var(--header-text-strong);
  }

  .result-item.active {
    border-color: var(--header-accent-border-strong);
    background: var(--header-search-bg-hover);
    color: var(--header-text-strong);
    box-shadow: 0 0 0 1px var(--header-accent-border-strong);
  }

  .result-title {
    font-weight: 600;
    color: var(--header-text-strong);
    margin-bottom: 0.2rem;
  }

  .result-excerpt {
    font-size: 0.9rem;
    color: var(--header-text-muted);
    line-height: 1.5;
  }

  @keyframes shimmer {
    0% {
      transform: translateX(-100%);
    }
    50% {
      transform: translateX(0%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  :global(body.search-drawer-open) {
    overflow: hidden;
  }

  @media (max-width: 768px) {
    .search-drawer {
      padding: max(52px, 8vh) 12px 16px;
      align-items: flex-start;
    }

    .search-panel {
      border-radius: 10px;
      max-height: calc(100vh - 10vh);
    }

    .search-input-wrap {
      padding: 0.6rem 0.8rem;
    }

    .search-body {
      gap: 0.65rem;
    }

    .search-results {
      min-height: 200px;
    }
  }
</style>

<script type="module" is:inline>
  const drawer = document.getElementById('search-drawer')
  const backdrop = drawer?.querySelector('.search-backdrop')
  const closeControls = drawer?.querySelectorAll('[data-close]')
  const input = drawer?.querySelector('#search-drawer-input')
  const metaTitle = drawer?.querySelector('.meta-title')
  const metaHint = drawer?.querySelector('.meta-hint')
  const resultsBox = drawer?.querySelector('.search-results')
  const loadingText = drawer?.querySelector('[data-loading-text]')
  const resultsList = drawer?.querySelector('.results-list')
  const emptyTitle = drawer?.querySelector('.results-empty .empty-title')
  const emptyHint = drawer?.querySelector('.results-empty .empty-hint')

  const bundlePathRaw = drawer?.dataset.bundlePath || '/pagefind/'
  const basePath = drawer?.dataset.basePath || '/'
  const bundlePath = bundlePathRaw.endsWith('/')
    ? bundlePathRaw
    : `${bundlePathRaw}/`
  const pagefindEntry = `${bundlePath}pagefind.js`

  let isOpen = false
  let pagefind
  let enginePromise
  let engineReady = false
  let searchTicket = 0
  let currentResults = []
  let activeIndex = -1

  const debounce = (fn, delay) => {
    let timer
    return (...args) => {
      clearTimeout(timer)
      timer = window.setTimeout(() => fn(...args), delay)
    }
  }

  const setMeta = (title, hint) => {
    if (metaTitle) metaTitle.textContent = title
    if (metaHint) metaHint.textContent = hint
  }

  const setState = (state) => {
    resultsBox?.setAttribute('data-state', state)
  }

  const setEmptyView = (title, hint) => {
    if (emptyTitle) emptyTitle.textContent = title
    if (emptyHint) emptyHint.textContent = hint
  }

  const normalizeUrl = (url) => {
    if (!url) return '#'
    if (/^https?:\/\//.test(url) || url.startsWith('/')) return url
    const prefix = basePath.endsWith('/') ? basePath : `${basePath}/`
    return `${prefix}${url}`
  }

  const getResultItems = () =>
    Array.from(resultsList?.querySelectorAll('.result-item') ?? [])

  const clearActive = () => {
    activeIndex = -1
    input?.removeAttribute('aria-activedescendant')
    getResultItems().forEach((item) => {
      item.classList.remove('active')
      item.removeAttribute('aria-selected')
    })
  }

  const setActive = (nextIndex) => {
    const items = getResultItems()
    if (!items.length) {
      clearActive()
      return
    }
    const normalized =
      ((nextIndex % items.length) + items.length) % items.length
    activeIndex = normalized
    items.forEach((item, idx) => {
      const isActive = idx === normalized
      item.classList.toggle('active', isActive)
      if (isActive) {
        item.setAttribute('aria-selected', 'true')
        if (!item.id) item.id = `search-result-${idx}`
        input?.setAttribute('aria-activedescendant', item.id)
        item.scrollIntoView({ block: 'nearest' })
      } else {
        item.removeAttribute('aria-selected')
      }
    })
  }

  const moveActive = (delta) => {
    const items = getResultItems()
    if (!items.length) return
    if (activeIndex === -1) {
      setActive(delta > 0 ? 0 : items.length - 1)
      return
    }
    setActive(activeIndex + delta)
  }

  const activateResult = () => {
    const items = getResultItems()
    if (!items.length) return false
    const target =
      activeIndex === -1
        ? items[0]
        : items[((activeIndex % items.length) + items.length) % items.length]
    target.click()
    return true
  }

  const handleEmpty = () => {
    currentResults = []
    if (resultsList) resultsList.innerHTML = ''
    clearActive()
    const nextState = engineReady ? 'empty' : 'idle'
    setEmptyView(
      '等待输入',
      engineReady ? '输入后自动搜索' : '索引加载后可搜索'
    )
    setState(nextState)
    setMeta(
      '实时搜索',
      engineReady ? '输入后自动搜索' : '首次打开会自动加载索引'
    )
  }

  const renderResults = (items) => {
    if (!resultsList) return
    resultsList.innerHTML = ''
    clearActive()
    const fragment = document.createDocumentFragment()
    items.forEach((item, index) => {
      const link = document.createElement('a')
      link.className = 'result-item'
      link.href = normalizeUrl(item.url)
      link.dataset.index = String(index)
      link.id = `search-result-${index}`
      link.setAttribute('role', 'option')
      const title = document.createElement('div')
      title.className = 'result-title'
      title.textContent = item.title || item.url
      const excerpt = document.createElement('div')
      excerpt.className = 'result-excerpt'
      excerpt.textContent = item.excerpt || ''
      link.appendChild(title)
      link.appendChild(excerpt)
      fragment.appendChild(link)
    })
    resultsList.appendChild(fragment)
  }

  const loadPagefind = async () => {
    if (engineReady) return pagefind
    if (enginePromise) return enginePromise
    setState('engine-loading')
    if (loadingText) loadingText.textContent = '正在加载搜索索引…'
    setMeta('加载搜索索引', '首次打开会自动加载 Pagefind')
    enginePromise = import(pagefindEntry)
      .then((mod) => {
        pagefind = mod
        engineReady = true
        handleEmpty()
        return pagefind
      })
      .catch((error) => {
        console.error('Pagefind 加载失败', error)
        setState('error')
        setMeta('搜索不可用', '本地未找到索引，请运行 npm run preview:search')
        return null
      })
    return enginePromise
  }

  const runSearch = async (query) => {
    const mod = await loadPagefind()
    if (!mod) return
    const ticket = ++searchTicket
    setState('searching')
    if (loadingText) loadingText.textContent = '搜索中…'
    setMeta('正在搜索', `“${query}”`)
    try {
      const result = await mod.search(query)
      if (ticket !== searchTicket) return
      const entries = await Promise.all(
        result.results.slice(0, 20).map(async (item) => {
          const data = await item.data()
          return {
            url: data.url,
            title: (data.meta && data.meta.title) || data.url,
            excerpt: data.excerpt || '',
          }
        })
      )
      if (ticket !== searchTicket) return
      currentResults = entries
      renderResults(entries)
      if (entries.length === 0) {
        setEmptyView('没有找到结果', '换个关键词或检查拼写')
        setState('empty')
        setMeta('没有找到结果', '换个关键词试试')
      } else {
        setState('results')
        setMeta(`找到 ${entries.length} 条结果`, '方向键选择，Enter 打开结果')
      }
    } catch (error) {
      if (ticket !== searchTicket) return
      console.error('Pagefind 搜索失败', error)
      setState('error')
      setMeta('搜索失败', '请稍后重试')
    }
  }

  const debouncedSearch = debounce((value) => {
    const query = value.trim()
    if (!query) {
      handleEmpty()
      return
    }
    runSearch(query)
  }, 300)

  const emitState = () => {
    document.dispatchEvent(
      new CustomEvent('search-drawer:state', { detail: { open: isOpen } })
    )
  }

  const openDrawer = () => {
    if (isOpen || !drawer) return
    isOpen = true
    drawer.classList.add('open')
    drawer.setAttribute('aria-hidden', 'false')
    document.body.classList.add('search-drawer-open')
    window.requestAnimationFrame(() => {
      input?.focus()
      input?.select()
    })
    loadPagefind()
    emitState()
  }

  const closeDrawer = () => {
    if (!isOpen || !drawer) return
    isOpen = false
    drawer.classList.remove('open')
    drawer.setAttribute('aria-hidden', 'true')
    document.body.classList.remove('search-drawer-open')
    input?.blur()
    emitState()
  }

  const toggleDrawer = () => {
    if (isOpen) {
      closeDrawer()
    } else {
      openDrawer()
    }
  }

  input?.addEventListener('input', (event) => {
    const value = (event.target && event.target.value) || ''
    debouncedSearch(value)
  })

  input?.addEventListener('keydown', (event) => {
    if (!isOpen) return
    if (event.key === 'ArrowDown') {
      event.preventDefault()
      moveActive(1)
    } else if (event.key === 'ArrowUp') {
      event.preventDefault()
      moveActive(-1)
    } else if (event.key === 'Enter') {
      const opened = activateResult()
      if (opened) event.preventDefault()
    }
  })

  backdrop?.addEventListener('click', closeDrawer)
  closeControls?.forEach((el) => el.addEventListener('click', closeDrawer))

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && isOpen) {
      closeDrawer()
    }
  })

  document.addEventListener('open-search-drawer', openDrawer)
  document.addEventListener('close-search-drawer', closeDrawer)
  document.addEventListener('toggle-search-drawer', toggleDrawer)

  emitState()
</script>
