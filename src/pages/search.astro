---
import ContentLayout from '../layouts/ContentLayout.astro'

const q = Astro.url.searchParams.get('q') ?? ''
const base = import.meta.env.BASE_URL ?? '/'
const bundlePath = (base.endsWith('/') ? base : base + '/') + 'pagefind/'
---

<ContentLayout title="搜索" section="搜索" contributors={null}>
  <link href="/pagefind/pagefind-ui.css" rel="stylesheet" />

  <div data-pagefind-ignore="true">
    <h1>搜索</h1>
    <div id="search" data-bundle-path={bundlePath} data-initial={q}></div>
  </div>

  <script is:inline src="/pagefind/pagefind-ui.js"></script>

  <script is:inline>
    window.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('search')
      const bundlePath = container?.dataset.bundlePath || '/pagefind/'
      const initial = container?.dataset.initial || ''

      const ui = new PagefindUI({
        element: '#search',
        showSubResults: false,
        showImages: false,
        bundlePath,
        translations: {
          placeholder: '搜索文档…',
          zero_results: '没有找到与"{term}"相关的内容',
          clear_search: '清除',
          load_more: '加载更多',
        },
      })

      if (initial) {
        setTimeout(() => {
          const input = document.querySelector('#search input')
          if (input) input.value = initial
          if (typeof ui.triggerSearch === 'function') {
            ui.triggerSearch(initial)
          }
        }, 100)
      }

      if (
        window.location.hostname === 'localhost' ||
        window.location.hostname === '127.0.0.1'
      ) {
        fetch('/pagefind/pagefind.js', { method: 'HEAD' }).catch(() => {
          const note = document.createElement('div')
          note.textContent =
            '提示：开发模式仅展示搜索框。要体验完整搜索，请运行：npm run preview:search'
          note.style.fontSize = '12px'
          note.style.opacity = '0.7'
          note.style.marginBottom = '8px'
          note.style.padding = '8px'
          note.style.backgroundColor = '#fffbea'
          note.style.border = '1px solid #ffc107'
          note.style.borderRadius = '4px'
          container?.prepend(note)
        })
      }
    })
  </script>

  <style>
    #search {
      margin-top: 1rem;
    }
  </style>
</ContentLayout>
