---
title: Gateway
description: API 网关、代理转发与协议转换的核心概念。
contributors:
  - claude
  - gemini
---

API 网关是你的应用和上游模型之间的中间层。它不是可选的花哨功能，而是生产环境的必需品。

```text
+-----------+      +-------------+      +-----------------+
| 你的应用   |----->|   网关/代理  |----->| 上游模型服务     |
+-----------+      +-------------+      +-----------------+
                         |
                   转发 / 路由 / 转换
```

直连上游 API 的问题：
- 网络不通（墙、延迟、不稳定）
- Key 被封（单 IP 请求过多）
- 换模型要改代码
- 不同模型协议不兼容

网关解决所有这些问题。

## 核心能力

| 能力 | 说明 |
|:---|:---|
| **代理转发** | 把请求转发到上游，解决网络问题 |
| **路由分发** | 根据模型名、租户、策略分发到不同上游 |
| **协议转换** | 把 OpenAI 格式转成 Claude 格式，或反过来 |
| **Key 管理** | 多 Key 轮询、配额控制、防封号 |
| **监控观测** | 记录请求量、延迟、错误率 |

## 代理转发

最基础的能力：把请求从 A 点送到 B 点。

```text
Client (中国) ---> Proxy (海外) ---> OpenAI/Claude/Gemini
```

为什么需要：
- **跨境访问**：国内无法直连 OpenAI、Claude、Gemini
- **稳定性**：代理节点可以做负载均衡、故障转移
- **隐私**：上游只看到代理 IP，不知道真实客户端

使用方式极其简单：把 SDK 的 `base_url` 指向代理地址，其他代码不用改。

## 路由分发

当你有多个上游时，网关决定请求发给谁。

```text
                    +--> OpenAI (主力)
                    |
Gateway --路由规则--+--> Claude (备用)
                    |
                    +--> 本地模型 (降级)
```

常见路由策略：
- **模型映射**：`gpt-4` 发给 OpenAI，`claude-3` 发给 Anthropic
- **负载均衡**：多个 Key 轮询，分散压力
- **故障转移**：主上游挂了，自动切备用
- **A/B 测试**：10% 流量走新模型

## 协议转换

不同厂商的 API 格式不一样。网关可以在中间做翻译。

| 厂商 | 端点 | 认证方式 | 消息格式 |
|:---|:---|:---|:---|
| OpenAI | `/v1/chat/completions` | `Authorization: Bearer` | `messages: [{role, content}]` |
| Anthropic | `/v1/messages` | `x-api-key` | `messages: [{role, content}]` |
| Gemini | `/v1beta/models/*/generateContent` | `x-goog-api-key` | `contents: [{role, parts}]` |

协议转换的本质：
1. 解析调用方请求（比如 OpenAI 格式）
2. 转换成上游格式（比如 Claude 格式）
3. 发送请求，拿到响应
4. 把响应转回调用方期望的格式

这样你的代码只需要写一套 OpenAI 格式，网关帮你对接所有模型。

## 聚合管理

当规模变大，你需要更多能力：

| 需求 | 解决方案 |
|:---|:---|
| 多租户 | 每个用户/团队独立配额 |
| 计费 | 记录 token 消耗，生成账单 |
| 限流 | 防止单用户打爆系统 |
| 审计 | 记录谁在什么时候调了什么 |

这就是"聚合管理"——把多个上游、多个用户、多种策略统一管理。

## 架构演进

从简单到复杂：

**阶段 1：单代理**
```text
Client --> Proxy --> OpenAI
```
解决网络问题，够用就行。

**阶段 2：多上游**
```text
Client --> Gateway --> OpenAI / Claude / Gemini
```
支持多模型，统一入口。

**阶段 3：聚合平台**
```text
Client --> Gateway --> 路由 --> 多上游
              |
           配额/计费/监控
```
生产级，支持多租户和运营。

## 选择建议

| 场景 | 建议 |
|:---|:---|
| 个人开发 | 简单代理，Cloudflare Workers 或 Nginx |
| 小团队 | 开源网关（LiteLLM、OneAPI） |
| 生产环境 | 聚合平台 + 监控 + 计费 |

具体项目推荐见 [资源合集 - API Key](/resources/api)。

## 总结

- **代理**：解决网络问题
- **路由**：解决多上游问题
- **转换**：解决协议差异问题
- **聚合**：解决规模化运营问题

理解这些概念后，选什么工具、怎么部署都是细节问题。
