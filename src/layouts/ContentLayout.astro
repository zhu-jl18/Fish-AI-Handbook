---
import BaseLayout from './BaseLayout.astro'
import Header from '../components/Header.astro'
import RightSidebar from '../components/RightSidebar.astro'
import MobileMenu from '../components/MobileMenu.astro'
import BackToTop from '../components/BackToTop.astro'
import ContentActions from '../components/ContentActions.astro'
import { getSidebarForPath } from '../scripts/sidebars'
import { theme, getCurrentNavKey } from '../config/index'
import { getGitLastModifiedIso } from '../utils/git'

/**
 * 正文字体等排版尺寸由 src/config/theme.ts 控制
 * 通过内联样式将 theme 配置注入到 .content-inner，确保仅影响正文区域
 */

const currentPath = Astro.url.pathname
const sidebarItems = getSidebarForPath(currentPath)

const {
  title,
  headings = [],
  contributors,
  bodyClass,
  entry,
} = Astro.props as {
  title: string
  headings?: any[]
  contributors?: any
  bodyClass?: string
  entry?: any
}

const lastModified =
  entry?.data?.lastModified ?? getGitLastModifiedIso(entry?.filePath)

// 基于 URL 别名推导导航高亮键（不依赖中文文案）
const currentKey = getCurrentNavKey(currentPath)

// 从 entry 对象获取 entryId（用于 ContentActions 组件）
const entryId = entry?.id

// 提取 chapter（从 URL 路径的第一段）
const pathSegments = currentPath.split('/').filter(Boolean)
const chapter = pathSegments[0] || 'all'

// 顶层章节入口页（/daily, /resources 等）不展示 TOC 面板
const isChapterIndex = pathSegments.length === 1

// 提取 author（优先取非 Fish 的第一个 contributor）
const contributorsList = Array.isArray(contributors) ? contributors : []
const author =
  contributorsList.find((c: string) => c.toLowerCase() !== 'fish') ||
  contributorsList[0] ||
  'Fish'
---

<BaseLayout title={title} bodyClass={bodyClass} contributors={contributors}>
  <Header currentPage={currentKey} />

  <div class="content-wrapper">
    <div class="layout-container">
      <main id="main-content" class={`content ${entryId ? 'has-actions' : ''}`}>
        <div
          class="content-inner"
          data-pagefind-body
          style={`--font-size-base: ${theme.fontSizeBase}; --font-size-lg: ${theme.fontSizeLg}; --line-height-base: ${theme.lineHeightBase};`}
        >
          <span data-pagefind-filter="chapter" class="visually-hidden"
            >{chapter}</span
          >
          <span data-pagefind-filter="author" class="visually-hidden"
            >{author}</span
          >
          {
            entryId && (
              <ContentActions entryId={entryId} lastModified={lastModified} />
            )
          }
          <slot />
        </div>
      </main>

      <RightSidebar
        headings={headings}
        structure={sidebarItems}
        currentPath={currentPath}
        contributors={contributors}
        showTocPanel={!isChapterIndex}
      />
    </div>
  </div>

  <MobileMenu
    structure={sidebarItems}
    currentPath={currentPath}
    contributors={contributors}
    showTocPanel={!isChapterIndex}
  />

  <button
    class="mobile-menu-trigger"
    aria-label="Open menu"
    title="目录与章节"
    aria-controls="mobile-menu-overlay"
    aria-expanded="false"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>

  <BackToTop />
</BaseLayout>

<style>
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .content-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 60px;
    flex: 1;
    width: 100%;
    background-color: var(--bg-color);
  }

  .layout-container {
    display: flex;
    gap: var(--layout-gap);
    max-width: var(--layout-max-width);
    width: 100%;
    padding: 0 calc(var(--layout-gap) + 1rem);
    position: relative;
    justify-content: center;
    align-items: flex-start;
    margin: 0 auto;
  }

  .content {
    flex: 0 1 var(--content-max-width);
    width: min(100%, var(--content-max-width));
    padding: 1.5rem 2rem 2.5rem 2rem;
    background-color: transparent;
    border-radius: 0;
    max-width: var(--content-max-width);
  }

  /* 当顶部存在操作按钮时，大幅缩小内容区域的上边距 */
  /* 当顶部存在操作按钮时，正文内容整体下移以匹配右侧sidebar的对齐 */
  .content.has-actions {
    /* 桌面默认：让工具栏图标中心线与右侧 CHAPTER 顶线对齐 */
    padding-top: 6px;
  }

  .content-inner {
    width: 100%;
    font-size: var(--font-size-base);
    line-height: var(--line-height-base);

    /* Doc 级标题尺度通过 CSS 变量覆写，避免与全局样式重复 */
    --heading-h1-size: clamp(1.6rem, 1.6vw + 0.5rem, 1.9rem);
    --heading-h1-margin-top: calc(var(--section-spacing) * 0.75);
    --heading-h1-margin-bottom: 1rem;

    --heading-h2-size: clamp(1.15rem, 1vw + 0.65rem, 1.35rem);
    --heading-h2-margin-top: calc(var(--section-spacing) * 0.6);
    --heading-h2-margin-bottom: 0.75rem;
    --heading-h2-border: 1px solid var(--heading-divider-color);
    --heading-h2-padding-bottom: 0.3em;

    --heading-h3-size: clamp(1.1rem, 0.8vw + 0.75rem, 1.3rem);
    --heading-h3-margin-top: 1.4rem;
    --heading-h3-margin-bottom: 1.1rem;

    --heading-h4-size: 1rem;
    --heading-h4-margin-top: 1.3rem;
    --heading-h4-margin-bottom: 0.45rem;

    --heading-h5-size: 0.95rem;
    --heading-h5-margin-top: 1.15rem;
    --heading-h5-margin-bottom: 0.4rem;

    --heading-h6-size: 0.9rem;
    --heading-h6-margin-top: 1rem;
    --heading-h6-margin-bottom: 0.35rem;
    --heading-h6-letter-spacing: -0.005em;
  }

  /* 移除第一个标题的顶部外边距，确保与侧边栏对齐 */
  .content-inner > :global(:is(h1, h2, h3, h4, h5, h6):first-child) {
    margin-top: 0;
  }

  /* 当存在操作按钮时，按钮后第一个元素保留合适的间距 */
  .content-inner > :global(.content-actions + *) {
    margin-top: 1rem !important;
  }

  /* 标题颜色由全局控制；此处仅通过变量覆写尺寸/间距 */

  @media (max-width: 1440px) {
    .layout-container {
      padding: 0 calc(var(--layout-gap) * 0.75);
    }

    .content {
      padding: 1.5rem 1.85rem 2.25rem 1.85rem;
    }

    .content.has-actions {
      /* 桌面<=1440：保持与右侧对齐 */
      padding-top: 6px;
    }
  }

  @media (max-width: 1200px) {
    .content {
      padding: 1.5rem 1.75rem 2rem 1.75rem;
    }
    .content.has-actions {
      /* 桌面<=1200：保持与右侧对齐 */
      padding-top: 6px;
    }
  }

  @media (max-width: 1024px) {
    .layout-container {
      gap: 0;
      padding: 0;
    }

    .content {
      flex: 1;
      width: 100%;
      border-radius: 0;
      max-width: 100%;
      padding: 1.5rem 1.5rem 2rem 1.5rem;
    }

    .content.has-actions {
      padding-top: 0.25rem;
    }
  }

  @media (max-width: 768px) {
    .content {
      padding: 1.5rem 1rem 1.5rem 1rem;
    }
    .content.has-actions {
      padding-top: 0.25rem;
    }
  }
  /* 针对桌面端已在基础规则固定为 6px；下面断点仅调整小屏表现 */

  .mobile-menu-trigger {
    position: fixed;
    right: 5.5rem; /* 平板端：BackToTop 右 2rem + 宽 44px + 间距 0.5rem */
    bottom: 2rem; /* 与 BackToTop 对齐 */
    width: 44px; /* 与 BackToTop 一致 */
    height: 44px;
    display: none; /* Hidden on desktop */
    align-items: center;
    justify-content: center;
    background: var(--color-bg-overlay-dark);
    border: 1px solid var(--color-border-overlay);
    color: var(--color-text-overlay);
    border-radius: 50%;
    cursor: pointer;
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 100;
    transition: all 0.2s ease;
  }

  .mobile-menu-trigger:hover {
    background: var(--color-bg-overlay-hover);
    color: var(--color-text-white);
    border-color: var(--color-border-overlay-hover);
    transform: translateY(-2px);
  }

  .mobile-menu-trigger:active {
    transform: translateY(0);
  }

  @media (max-width: 1024px) {
    .mobile-menu-trigger {
      display: inline-flex;
    }
  }
  @media (max-width: 768px) {
    .mobile-menu-trigger {
      right: 1rem;
      width: 40px; /* 移动端缩小与 BackToTop 一致 */
      height: 40px;
      /* 垂直堆叠：BackToTop 底部 1rem + 高 40px + 间距 12px */
      bottom: calc(1rem + 40px + 12px);
    }
  }
</style>

<script>
  const trigger = document.querySelector('.mobile-menu-trigger')
  trigger?.addEventListener('click', () => {
    document.dispatchEvent(new CustomEvent('open-mobile-menu'))
  })
</script>
